---
title: "R Tutorial For Business Analytics"
author: "Derek Lukacsko"
date: "September 8, 2016"
output: html_document
---


#Introduction

##Sources of help

1. Typing `?` followed by the function name e.g `?help` or `?sum`
1. [Google](www.google.co.uk)
2. [stackoverflow](http://www.stackoverflow.com)
3000. [Rstudio's cheatsheets](https://www.rstudio.com/resources/cheatsheets/) (for this you'll neeed the wrangling and ggplot ones)
4. [ggplot2 help website](http://docs.ggplot2.org/current/)

#Setup
Setting up the environment can be very helpful to do in one place this first code chunk can store all the packages you need in your analysis, load any custom functions that you have made through out the analysis and store the locations of any folders that you use for easy folder switching.

**TIPS**
* Short cuts can be very helpful especially inserting a new chunk using `ctrl+alt+i`
* Creating a folder structure for you projects keeps everything easy to find, functions in the function folder, data in the data folder etc.

```{r Setting Up Environment, message=FALSE}
# Directory
#setwd(file.path = "")

# Load packages
packages <- c("tidyverse")

#This piece of code will check to see if the packages you want to load are installed if they aren't it will install them
new.packages <- packages[!(packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)

invisible(sapply(packages, library, character.only = TRUE))

#save the starting directory as a variable
baswd <-getwd()
```




#Exploring the data


R contains many different data sets and additional data sets are usually installed with new packages. You can see what packages are installed on your machineby typing `data()` in the command line. packages can be loaded using the following methods
```{r}

data("airquality") #creates a promise
airquality %>% head #anything that calls the promises causes it to be evaluated
rm(airquality) #delete the dataframe

testdf <- airquality #loading can also be done like this
rm(testdf) #we don't need this variable cluttering up the workspace

```


Load the `mtcars` data frame and assign it to the variable `df`

```{r}
# Working dataframe
df <- mtcars
```

In R all the objects you work with have different classes these can be data frames, matrices, models, vectors etc. Different objects have different properties, meaning they react differently to the functions you try on them.

* With the data frame you have just loaded, use the functions,`class`, `dim`, `head`, `colnames`, `names`, `View`.
* Load the datasets `VADeaths` and `discoveries` and use the same functions, what happens? why do you think it happens?

```{r}

# Inspect the data
dim(df)
colnames(df)
View(head(df))
summary(df)
head(df)
```

Given that data frames can hold multiple data types it is worth checking what class each column in a data frame is. This can be boring to check one at a time so using a `for` loop could be an option. However R also has a group of functions called the `apply` family, `sapply`, and `lapply` being the most commonly used. These functions move across every element of a dataframe/matrix/list and perform a function on it returning the result.


* Use sapply to sum up each column of the dataframe `df` 
* Use `sapply` to find out the classes of each varible in `df` compare this to the classes found in the `iris` data set.

```{r using sapply}

sapply(df, sum)
#sapply(iris, sum)

sapply(df, class)
#sapply(iris, class)

```

Do you think the results of the summming function is surprising?


##Changing classes

As was seen in the previous exercise some of the variables of df could do with changing class. Class can be changed by calling `as.` before the class you want to convert to e.g `as.data.frame` if possible R will then coerce the object into the new class, or return an error if it is not possible.

A matrix can only hold a single class of information for example, integers **or** characters but not both. A data frame can hold multiple data types as long as they are vectors, this makes data frames much more flexible they are the building block of working in R. A list can hold whatever you like including other lists.

1. Change the cyl, vs, and am  variables to factors (Use `lapply` or `mutate_at` if you can work out how)
2. Change hp to an integer
3. Using sapply check the changes have taken place

**Tip**
For changes to variables in a dataframe or matrix use mutate (look at the wrangling cheatsheet).

```{r}

#Old school solution using lapply
df2 <-df
df2[,c(2,8,9)] <- lapply(c(2,8,9), function(n) as.factor(df2[,n]))
df2$hp <- as.integer(df2$hp)

#Modern style using chaining and dplyr
df %<>% mutate_at(c(2,8,9), as.factor) %>% mutate(hp= as.integer(hp))

sapply(df2, class)
sapply(df, class)
#Are they equal?
all.equal(sapply(df2, class), sapply(df, class))
#win
rm(df2)

```


1. Use rownames() and mutate() to make a new variable called "model" that has the names of the cars
2. Return the data frame with only th first 5 car models
3. Return the data frame with the top 5 most fuel efficient cars
4. Return a dataframe with the 5 least fuel efficient cars
5. Find the most fuel efficient car for each cylinder group

```{r Exercise 1: Data Cleaning}

df <- df %>% mutate(model = rownames(.))

df %>% top_n(5, mpg) #top 5 unordered
df %>% arrange(desc(mpg)) %>% top_n(5, mpg) #top 5 ordered
df %>% arrange(mpg) %>% head(5) #
df %>% arrange(desc(mpg)) %>% group_by(cyl) %>% summarise_all(first)


# Different ways to do the same thing
# df$Sepal.Length <-as.factor(df$Sepal.Length)
# df[,"Sepal.Length"] <- as.factor(df$Sepal.Length)
# df[,5] <- as.factor(df$Species)
# df <- df %>%
#   mutate(Sepal.Length = as.factor(Sepal.Length),
#          Species = as.factor(Species))
# 

# Number of missing values
# is.na(df) %>% sum
# 
# #Number of valid rows
# sum(complete.cases(df))
# 
# # What column is it in
# sapply(df, function(x) any(is.na(x)))
# 
# # What row is it in
# df[is.na(df$Sepal.Width),]
# 
# Remove the row manually

# Remove the row the easy way

# Replace the row as the median or mean 

```


#Creating Plots
In this section we willl explore using ggplot2 R's most popular plotting package to visualise data sets. We will begin using a simple scatter plot, and then build on it's complexity by adding "layers". After the scatter plot we will create a box plot. 


##Scatterplot 

I don't think jitter should be used, it doesn't add anything to the data and will make everyones graph look different whilst reducing the separation of the data. geom_point is more simple and and provides a better visual. 

The geom_smooth is quite advanced for a first few plots also it isn't working on my version

The facet wrap with grey dots in the background is awesome I've never done that before

1. Plot the relationship between variables Sepal.Length and Sepal.Width
2. Color the points by Species
3. Add a title

```{r Exercise 2: Data Inspection}
df<-iris

# Dot plot with linear fit
ggplot(df, aes(x=Sepal.Length,y=Sepal.Width)) + 
  geom_jitter() +
  geom_smooth(method = "lm", se = FALSE) +
  labs(title = "Relationship Between Sepal.Length and Sepal.Width")

# Dot plot colored by species with linear fit
ggplot(df, aes(x=Sepal.Length,y=Sepal.Width,color = Species)) + 
  #geom_jitter() + 
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  labs(title = "Relationship Between Sepal.Length and Sepal.Width \n by Species")

# Dot plot colored by species with linear fit, faceted by species
ggplot(df, aes(x=Sepal.Length,y=Sepal.Width,color = Species)) + 
  facet_wrap(~Species, nrow = 2) + #change nrow
  geom_point() + 
  geom_smooth(method = "lm", se = FALSE) +
  labs(title = "Relationship Between Sepal.Length and Sepal.Width \n Faceted by Species")

# Same as previous but with all point present in each plot
ggplot(df, aes(Sepal.Length,Sepal.Width, color = Species)) +
  geom_point(data = transform(df, Species = NULL), colour = "grey85") +
  geom_point() +
  geom_smooth(method = "lm", se =FALSE) +
  facet_wrap(~Species, nrow= 2) +
 labs(title = "Relationship Between Sepal.Length and Sepal.Width \n Faceted by Species")

```


I don't think we should be involved in outlier removal. That is a pretty controversial area, I don't think it is good to introduce it to this class. I would say that using boxplots and helping explain why they contain more information than bar plots would be a better move.

#Boxplot
Boxplots are a compact way of representing key statistics in categorical/factoral data. 

1. Make a box plot of Sepal.Length
2. Identify the rows that contain outliers
3. Handle the outliers
```{r Exercise 3: BoxPlots}
df <-iris

ggplot(df, aes(x= Species, y=Sepal.Length, fill =Species)) + 
  geom_boxplot()+
  labs(title = "Relationship Between Sepal.Length and Species")


```


1. Determine if Sepal.Length and Sepal.Width follow a Gaussian distribution using a test of normality
2. Make a histogram or frequency density plot to roughly visalize the feature distributions
3. Determine if the correlation between Sepal.Length and Sepal.Width is significant
```{r Exercise 4: test normality, test correlation}

# I don't know why df2 has been brought in
df2<-df
ggplot(df2, aes(Sepal.Width)) + 
  stat_bin(bins = 20,  fill="steelblue", color = "white") + 
  theme_bw()

ggplot(df2, aes(Sepal.Width)) + 
  geom_density(fill= "steelblue") + 
  theme_bw()

colnames(df2)
df2 <- df[,c(1:4)]
#This produces an error I don't kniw what you are trying to do
#cor.test(df2)

# Low P --> reject H0
cor.test(df2$Sepal.Length,df2$Sepal.Width, method = c("pearson"), conf.level = 0.95)[3]


```


#Asking Questions on SO

Without Stackoverflow programming would be an even more difficult and frustrating experience than it already is. SO has a lot of questions already answered, you will still probably want to ask some. However if you want to be an OG as well as an OP you should follow a few basic rules.

1. Make sure you have actually tried. The SO community is there to answer questions not hold hands and react badly when it looks like someone hasn't attempted the question themslef first.
2. Google it first! if there is already answer outthere especially if the answer is on SO already, your question will be voted down and closed.
3. Proivide a [minimal reproducible](http://stackoverflow.com/questions/5963269/how-to-make-a-great-r-reproducible-example) example. This is the most important thing to do once you have gone through the other two points. For R the best way to create a reproducible example is using `dput`. The key is providing just enough information so that the question is answerable. 


```{r dput, eval = FALSE}
 ?dput
#The script produced can be pasted into SO, other people can then copy the code and assign it a variable 
diamonds %>% head %>% dput

#Asign this structure to "test" and have a look at it
structure(list(Ozone = c(41L, 36L, 12L, 18L, NA, 28L, 23L, 19L, 
8L, NA, 7L, 16L, 11L, 14L, 18L, 14L, 34L, 6L, 30L, 11L), Solar.R = c(190L, 
118L, 149L, 313L, NA, NA, 299L, 99L, 19L, 194L, NA, 256L, 290L, 
274L, 65L, 334L, 307L, 78L, 322L, 44L), Wind = c(7.4, 8, 12.6, 
11.5, 14.3, 14.9, 8.6, 13.8, 20.1, 8.6, 6.9, 9.7, 9.2, 10.9, 
13.2, 11.5, 12, 18.4, 11.5, 9.7), Temp = c(67L, 72L, 74L, 62L, 
56L, 66L, 65L, 59L, 61L, 69L, 74L, 69L, 66L, 68L, 58L, 64L, 66L, 
57L, 68L, 62L), Month = c(5L, 5L, 5L, 5L, 5L, 5L, 5L, 5L, 5L, 
5L, 5L, 5L, 5L, 5L, 5L, 5L, 5L, 5L, 5L, 5L), Day = 1:20), .Names = c("Ozone", 
"Solar.R", "Wind", "Temp", "Month", "Day"), row.names = c(NA, 
20L), class = "data.frame")

#By doing this, classes, variuable names and everything important about the data is preserved and people will find it much easier to help you.

```



